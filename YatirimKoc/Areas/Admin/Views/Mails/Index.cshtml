@using YatirimKoc.Application.Common.Models
@model PaginatedList<YatirimKoc.Application.Features.Mails.Dtos.MailDto>
@{
    ViewData["Title"] = "Mail Havuzu (Aboneler)";
    Layout = "~/Areas/Admin/Views/Shared/AdminLayout.cshtml";
}

<div class="fade-in-up">
    <div class="glass-panel" style="border-radius: var(--radius-lg); padding: 25px; margin-bottom: 30px; border-left: 5px solid var(--accent-1);">
        <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:20px;">
            <div>
                <h2 style="margin:0; font-weight:800; letter-spacing:-0.5px;">E-Posta Aboneleri</h2>
                <p style="color: var(--muted); margin: 5px 0 0 0;">Bültene kayıtlı toplam @Model.TotalCount kişi listeleniyor.</p>
            </div>
            <button type="button" class="btn-primary" onclick="document.getElementById('addSubscriberModal').style.display='flex';" style="background:var(--accent-1); border:none;">
                <i class="fa-solid fa-plus me-2"></i> Yeni Abone Ekle
            </button>
        </div>

        <hr style="border-color: var(--glass-border); margin: 20px 0;" />

        <form method="get" asp-action="Index" style="display:flex; gap: 15px; align-items: center; max-width: 500px;">
            <input type="text" name="searchTerm" value="@ViewData["CurrentSearch"]" class="input-dark" placeholder="E-Posta adresi ara..." style="flex:1;" />
            <button type="submit" class="btn-primary" style="background:var(--accent-2);"><i class="fa-solid fa-search"></i></button>
            @if (!string.IsNullOrEmpty(ViewData["CurrentSearch"]?.ToString()))
            {
                <a asp-action="Index" class="btn-secondary" title="Filtreyi Temizle"><i class="fa-solid fa-times"></i></a>
            }
        </form>
    </div>

    <div class="glass-panel" style="border-radius: var(--radius-lg); padding: 10px; overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse; min-width:600px;">
            <thead>
                <tr style="color: var(--muted); font-size:12px; text-transform:uppercase; border-bottom: 1px solid var(--glass-border);">
                    <th style="padding: 20px; text-align:left;">E-Posta Adresi</th>
                    <th style="padding: 20px; text-align:left;">Kayıt Tarihi</th>
                    <th style="padding: 20px; text-align:left;">Durum</th>
                    <th style="padding: 20px; text-align:right;">İşlemler</th>
                </tr>
            </thead>
            <tbody>
                @if (Model.Items.Any())
                {
                    foreach (var item in Model.Items)
                    {
                        <tr class="table-row-hover" style="border-bottom: 1px solid rgba(255,255,255,0.03);" id="row-@item.Id">
                            <td style="padding: 15px 20px; font-weight:600; color:#fff;">
                                <i class="fa-regular fa-envelope me-2" style="color:var(--accent-2);"></i>@item.Email
                            </td>
                            <td style="padding: 15px 20px; color:var(--muted); font-size:14px;">
                                @item.CreatedAt.ToString("dd MMMM yyyy")
                            </td>
                            <td style="padding: 15px 20px;">
                                @if (item.IsActive)
                                {
                                    <span style="background:rgba(16,185,129,0.1); color:#10b981; padding:5px 12px; border-radius:20px; font-size:11px; font-weight:700;"><i class="fa-solid fa-check me-1"></i> Aktif</span>
                                }
                                else
                                {
                                    <span style="background:rgba(239,68,68,0.1); color:#ef4444; padding:5px 12px; border-radius:20px; font-size:11px; font-weight:700;"><i class="fa-solid fa-times me-1"></i> Pasif</span>
                                }
                            </td>
                            <td style="padding: 15px 20px; text-align:right;">
                                <button type="button" style="width:35px; height:35px; border-radius:8px; background:rgba(239,68,68,0.1); color:#ef4444; border:1px solid rgba(239,68,68,0.2); cursor:pointer; transition:all 0.3s;" onmouseover="this.style.background='#ef4444'; this.style.color='#fff';" onmouseout="this.style.background='rgba(239,68,68,0.1)'; this.style.color='#ef4444';" onclick="openDeleteModal('@item.Id', '@item.Email')">
                                    <i class="fa-solid fa-trash-can"></i>
                                </button>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="4" style="padding: 40px; text-align:center; color:var(--muted);">
                            <i class="fa-regular fa-folder-open mb-3" style="font-size:40px; opacity:0.5;"></i>
                            <p>Henüz kayıtlı bir e-posta adresi bulunmuyor.</p>
                        </td>
                    </tr>
                }
            </tbody>
        </table>

        @if (Model.TotalPages > 1)
        {
            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:25px; padding:0 10px;">
                <div style="color:var(--muted); font-size:14px;">Sayfa <b>@Model.PageNumber</b> / @Model.TotalPages</div>
                <div style="display:flex; gap:10px;">
                    <a asp-action="Index" asp-route-pageNumber="@(Model.PageNumber - 1)" asp-route-searchTerm="@ViewData["CurrentSearch"]" class="btn-secondary" style="pointer-events: @(!Model.HasPreviousPage ? "none" : "auto"); opacity: @(!Model.HasPreviousPage ? "0.4" : "1");">Önceki</a>
                    <a asp-action="Index" asp-route-pageNumber="@(Model.PageNumber + 1)" asp-route-searchTerm="@ViewData["CurrentSearch"]" class="btn-secondary" style="pointer-events: @(!Model.HasNextPage ? "none" : "auto"); opacity: @(!Model.HasNextPage ? "0.4" : "1");">Sonraki</a>
                </div>
            </div>
        }
    </div>
</div>

<div id="addSubscriberModal" class="modal-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); backdrop-filter:blur(5px); z-index:9999; align-items:center; justify-content:center;">
    <div class="glass-panel" style="width:400px; padding:35px 30px; border-radius:20px; border-top:5px solid var(--accent-1); text-align:center;">
        <div style="width:60px; height:60px; background:rgba(139,92,246,0.1); border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 20px auto; color:var(--accent-1); font-size:25px;">
            <i class="fa-solid fa-envelope-open-text"></i>
        </div>
        <h3 style="color:#fff; margin-bottom:10px; font-weight:700;">Yeni Abone Ekle</h3>
        <p style="color:var(--muted); font-size:14px; margin-bottom:25px;">Bülten havuzuna eklenecek e-posta adresini giriniz.</p>

        <form asp-action="Create" method="post">
            <input type="email" name="email" class="input-dark mb-4" placeholder="ornek@mail.com" required style="text-align:center;" />

            <div style="display:flex; gap:15px;">
                <button type="button" class="btn-secondary" style="flex:1; justify-content:center;" onclick="document.getElementById('addSubscriberModal').style.display='none';">İptal</button>
                <button type="submit" class="btn-primary" style="flex:1; justify-content:center; background:var(--accent-1);">Ekle</button>
            </div>
        </form>
    </div>
</div>

<div id="deleteMailModal" class="modal-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); backdrop-filter:blur(5px); z-index:9999; align-items:center; justify-content:center;">
    <div class="glass-panel" style="width:400px; padding:35px 30px; border-radius:20px; border-top:5px solid #ef4444; text-align:center;">
        <div style="width:60px; height:60px; background:rgba(239,68,68,0.1); border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 20px auto; color:#ef4444; font-size:25px;">
            <i class="fa-solid fa-triangle-exclamation"></i>
        </div>
        <h3 style="color:#fff; margin-bottom:10px; font-weight:700;">Aboneyi Sil?</h3>
        <p style="color:var(--muted); font-size:14px; margin-bottom:20px;"><b><span id="deleteMailTarget"></span></b> adresi bültenden çıkarılacaktır. Bu işlem geri alınamaz.</p>

        <div style="display:flex; justify-content:center; gap:15px;">
            <button type="button" class="btn-secondary" onclick="closeDeleteModal()" style="flex:1;">İptal</button>
            <button type="button" class="btn-primary" onclick="executeDelete()" style="flex:1; background:linear-gradient(135deg, #ef4444, #b91c1c); box-shadow:0 4px 15px rgba(239,68,68,0.3);">Evet, Sil</button>
        </div>
        <input type="hidden" id="deleteMailId" />
    </div>
</div>

@section Scripts {
    <script>
        function openDeleteModal(id, email) {
            document.getElementById('deleteMailId').value = id;
            document.getElementById('deleteMailTarget').innerText = email;
            document.getElementById('deleteMailModal').style.display = 'flex';
        }

        function closeDeleteModal() {
            document.getElementById('deleteMailModal').style.display = 'none';
        }

        function executeDelete() {
            const id = document.getElementById('deleteMailId').value;
            $.post('/Admin/Mails/Delete', { id: id }, function(res) {
                if(res.success) {
                    location.reload();
                } else {
                    alert(res.message);
                    closeDeleteModal();
                }
            });
        }
    </script>
}