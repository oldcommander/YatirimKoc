@model YatirimKoc.Web.Areas.Admin.Models.UpdateListingViewModel
@{
    ViewData["Title"] = "İlanı Güncelle - " + Model.Title;
    Layout = "~/Areas/Admin/Views/Shared/AdminLayout.cshtml";
}

<div class="fade-in-up">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 25px;">
        <h2 style="margin:0; font-weight:800; color:#fff;">İlanı Düzenle</h2>
        <a asp-action="Index" class="btn-secondary" style="text-decoration:none;">
            <i class="fa-solid fa-arrow-left"></i> Listeye Dön
        </a>
    </div>

    <form asp-action="Edit" method="post" enctype="multipart/form-data" id="editForm">
        <input type="hidden" asp-for="Id" />
        <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

        <div class="form-grid" style="grid-template-columns: 1.5fr 1fr; align-items: start;">

            <div style="display:flex; flex-direction:column; gap:25px;">

                <div class="glass-panel" style="padding:25px; border-radius:var(--radius-lg);">
                    <h4 style="color:var(--accent-2); border-bottom:1px solid var(--glass-border); padding-bottom:10px; margin-bottom:20px;">Temel Bilgiler</h4>

                    <div class="form-group">
                        <label asp-for="Title">İlan Başlığı</label>
                        <input asp-for="Title" class="input-dark" />
                        <span asp-validation-for="Title" class="text-danger"></span>
                    </div>

                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                        <div class="form-group">
                            <label asp-for="Price">Fiyat (TL)</label>
                            <input asp-for="Price" type="number" step="0.01" class="input-dark"
                                   value="@Model.Price.ToString("0.##", System.Globalization.CultureInfo.InvariantCulture)" />
                            <span asp-validation-for="Price" class="text-danger"></span>
                        </div>
                        <div class="form-group">
                            <label asp-for="TransactionTypeId">İşlem Tipi</label>
                            <select asp-for="TransactionTypeId" class="input-dark" asp-items="@(new SelectList(ViewBag.TransactionTypes, "Id", "Name"))">
                                <option value="">Seçiniz</option>
                            </select>
                            <span asp-validation-for="TransactionTypeId" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="form-group mt-3">
                        <label asp-for="Description">İlan Açıklaması</label>
                        <textarea asp-for="Description" class="input-dark" rows="6"></textarea>
                        <span asp-validation-for="Description" class="text-danger"></span>
                    </div>
                </div>

                <div class="glass-panel" style="padding:25px; border-radius:var(--radius-lg);">
                    <h4 style="color:var(--accent-2); border-bottom:1px solid var(--glass-border); padding-bottom:10px; margin-bottom:20px;">Dinamik Özellikler</h4>

                    <div class="form-group">
                        <label asp-for="PropertyTypeId">Emlak Tipi (Kategori)</label>
                        <select asp-for="PropertyTypeId" class="input-dark" id="PropertyTypeSelect" asp-items="@(new SelectList(ViewBag.PropertyTypes, "Id", "Name"))">
                            <option value="">Kategori Seçiniz</option>
                        </select>
                        <small class="text-warning">Kategori değiştirirseniz alt özellikler sıfırlanır.</small>
                    </div>

                    <div id="dynamicFeaturesContainer" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top:20px;">
                    </div>
                </div>

            </div>

            <div style="display:flex; flex-direction:column; gap:25px;">

                <div class="glass-panel" style="padding:25px; border-radius:var(--radius-lg); border-top: 4px solid var(--accent-1);">
                    <div class="form-group mb-0">
                        <label class="d-flex align-items-center" style="cursor:pointer; font-size:16px; font-weight:600;">
                            <input asp-for="IsPublished" type="checkbox" style="width:20px; height:20px; margin-right:10px; accent-color:var(--accent-1);" />
                            Bu ilanı Yayında (Aktif) tut
                        </label>
                    </div>
                </div>

                <div class="glass-panel" style="padding:25px; border-radius:var(--radius-lg);">
                    <h4 style="color:var(--accent-2); border-bottom:1px solid var(--glass-border); padding-bottom:10px; margin-bottom:20px;">Konum Bilgileri</h4>

                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:15px;">
                        <div class="form-group">
                            <label asp-for="City">Şehir</label>
                            <select asp-for="City" class="input-dark" id="CitySelect">
                                <option value="Ankara">Ankara</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label asp-for="District">İlçe</label>
                            <select asp-for="District" class="input-dark" id="DistrictSelect">
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label style="display:flex; justify-content:space-between;">
                            <span>Harita Konumu (İşaretleyin)</span>
                            <span id="coordDisplay" style="color:var(--accent-2); font-size:12px;">Yükleniyor...</span>
                        </label>
                        <div id="mapWrapper" style="height: 250px; border-radius: var(--radius-md); overflow: hidden; border: 1px solid var(--glass-border);"></div>

                        <input type="hidden" name="Latitude" id="Latitude" value="@Model.Latitude" />
                        <input type="hidden" name="Longitude" id="Longitude" value="@Model.Longitude" />
                    </div>
                </div>

                <div class="glass-panel" style="padding:25px; border-radius:var(--radius-lg);">
                    <h4 style="color:var(--accent-2); border-bottom:1px solid var(--glass-border); padding-bottom:10px; margin-bottom:20px;">Görseller</h4>

                    @if (Model.ExistingImages != null && Model.ExistingImages.Any())
                    {
                        <div class="form-group">
                            <label>Kayıtlı Görseller (Silmek için X'e basın)</label>
                            <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:15px;" id="existingImagesContainer">
                                @foreach (var img in Model.ExistingImages)
                                {
                                    <div class="existing-image-box" id="img-box-@img.Id" style="position:relative; width:80px; height:80px; border-radius:8px; border:1px solid var(--glass-border);">
                                        <img src="@img.ImageUrl" style="width:100%; height:100%; object-fit:cover; border-radius:8px;" />
                                        <div onclick="removeExistingImage('@img.Id')" style="position:absolute; top:-8px; right:-8px; background:#ef4444; color:#fff; width:22px; height:22px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:11px; box-shadow:0 2px 5px rgba(0,0,0,0.5);">
                                            <i class="fa-solid fa-xmark"></i>
                                        </div>
                                    </div>
                                }
                            </div>
                            <div id="deletedImagesInputs"></div>
                        </div>
                    }

                    <div class="form-group">
                        <label>Yeni Görsel Ekle</label>
                        <div class="upload-box" id="dropArea" style="padding:20px; text-align:center; border:2px dashed rgba(255,255,255,0.2); border-radius:10px; cursor:pointer;">
                            <p style="margin:0; font-size:13px; color:var(--muted);">Sürükle bırak veya seç</p>
                            <input type="file" asp-for="NewFiles" id="fileInput" multiple hidden accept="image/*,video/*" />
                        </div>
                        <div id="previewArea" class="preview-area" style="margin-top:15px; display:flex; gap:10px; flex-wrap:wrap;"></div>
                    </div>

                </div>

                <button type="submit" class="btn-primary" style="width:100%; padding:15px; font-size:16px; background:linear-gradient(135deg, var(--accent-1), var(--accent-2));"><i class="fa-solid fa-floppy-disk"></i> Değişiklikleri Kaydet</button>

            </div>
        </div>
    </form>
</div>

@section Scripts {
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // 1. MEVCUT ÖZELLİKLERİ JS OBJESİ OLARAK ALIYORUZ
        var existingFeatures = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.FeatureValues));

        $(function () {
            // Ankara İlçeleri
            const ankaraDistricts = ["Akyurt", "Altındağ", "Ayaş", "Bala", "Beypazarı", "Çamlıdere", "Çankaya", "Çubuk", "Elmadağ", "Etimesgut", "Evren", "Gölbaşı", "Güdül", "Haymana", "Kahramankazan", "Kalecik", "Keçiören", "Kızılcahamam", "Mamak", "Nallıhan", "Polatlı", "Pursaklar", "Sincan", "Şereflikoçhisar", "Yenimahalle"];
            const districtSelect = $("#DistrictSelect");
            const currentDistrict = "@Model.District";

            ankaraDistricts.sort().forEach(d => {
                let selected = (d === currentDistrict) ? "selected" : "";
                districtSelect.append(`<option value="${d}" ${selected}>${d}</option>`);
            });

            loadFeatures($("#PropertyTypeSelect").val());

            $("#PropertyTypeSelect").on("change", function () {
                loadFeatures($(this).val());
            });

            setTimeout(initMap, 300);
        });

        // 2. DİNAMİK ÖZELLİKLERİ GETİREN FONKSİYON
        function loadFeatures(propertyTypeId) {
            var container = $("#dynamicFeaturesContainer");
            if (!propertyTypeId) { container.empty(); return; }

            container.html('<p class="text-muted" style="grid-column: span 2;">Özellikler yükleniyor...</p>');

            $.get("/Admin/Listings/GetFeatures?propertyTypeId=" + propertyTypeId, function (data) {
                container.empty();
                if (data.length === 0) return;

                data.forEach(function (feature) {
                    var html = '<div class="form-group" style="margin-bottom:0;">';
                    html += '<label>' + feature.name + '</label>';

                    var inputName = 'FeatureValues[' + feature.id + ']';
                    var existingVal = existingFeatures[feature.id] || "";

                    if (feature.inputType === "Select") {
                        html += '<select name="' + inputName + '" class="input-dark">';
                        html += '<option value="">Seçiniz</option>';
                        if (feature.options) {
                            var optionsArray = feature.options.split(',');
                            optionsArray.forEach(function(opt) {
                                var cleanOpt = opt.trim();
                                var selected = (cleanOpt === existingVal) ? "selected" : "";
                                html += `<option value="${cleanOpt}" ${selected}>${cleanOpt}</option>`;
                            });
                        }
                        html += '</select>';
                    } else if (feature.inputType === "Number") {
                        html += `<input type="number" name="${inputName}" class="input-dark" value="${existingVal}" />`;
                    } else {
                        html += `<input type="text" name="${inputName}" class="input-dark" value="${existingVal}" />`;
                    }
                    html += '</div>';
                    container.append(html);
                });
            });
        }

        // 3. MEVCUT RESİMLERİ SİLME İŞLEMİ
        function removeExistingImage(id) {
            $("#img-box-" + id).fadeOut(300, function() { $(this).remove(); });
            $("#deletedImagesInputs").append(`<input type="hidden" name="DeletedImageIds" value="${id}" />`);
        }

        // 4. HARİTA İŞLEMLERİ (FORMAT HATASI BURADA DÜZELTİLDİ)
        let map, marker;
        function initMap() {
            // Js içindeki virgülleri noktaya çevirip okuyalım
            let lat = parseFloat($("#Latitude").val().replace(',', '.'));
            let lng = parseFloat($("#Longitude").val().replace(',', '.'));

            // ÇÖZÜM 1: Sizin bahsettiğiniz temel kontrol
            if (lat > 1000) { lat = lat / 10000; }
            if (lng > 1000) { lng = lng / 10000; }

            // ÇÖZÜM 2: Ekstra Güvenlik (Çok büyük sayılar kaydedilmişse
            // doğru koordinat aralığına gelene kadar ondalık kaydırır)
            while (Math.abs(lat) > 90) { lat = lat / 10; }
            while (Math.abs(lng) > 180) { lng = lng / 10; }

            // Eğer NaN veya 0 dönerse varsayılan Türkiye Koordinatları
            if (lat === 0 || isNaN(lat)) { lat = 39.0; lng = 35.0; }

            // İlk yüklendiğinde düzelmiş koordinatı label üzerine yazdıralım
            $("#coordDisplay").text(lat.toFixed(4) + ", " + lng.toFixed(4));

            map = L.map('mapWrapper').setView([lat, lng], 13);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; CARTO' }).addTo(map);
            marker = L.marker([lat, lng]).addTo(map);

            map.on('click', function(e) {
                marker.setLatLng(e.latlng);

                // KRİTİK DEĞİŞİKLİK:
                // Eski kodunuzda "e.latlng.lat.toString().replace('.', ',')" kullanılıyordu.
                // Bu virgül, model binding esnasında soruna yol açıp sayıyı binlerce kat büyütüyordu.
                // Artık InvariantCulture standartında (Nokta ile) yazdırıyoruz.
                $("#Latitude").val(e.latlng.lat);
                $("#Longitude").val(e.latlng.lng);

                $("#coordDisplay").text(e.latlng.lat.toFixed(4) + ", " + e.latlng.lng.toFixed(4));
            });
            map.invalidateSize();
        }

        // 5. YENİ DOSYA YÜKLEME (Sürükle & Bırak Önizleme)
        const dropArea = document.getElementById("dropArea");
        const fileInput = document.getElementById("fileInput");
        const previewArea = document.getElementById("previewArea");
        let dataTransfer = new DataTransfer();

        dropArea.addEventListener("click", () => fileInput.click());
        fileInput.addEventListener("change", function () { appendFiles(this.files); });
        dropArea.addEventListener("dragover", e => { e.preventDefault(); dropArea.style.borderColor = "#7c3aed"; });
        dropArea.addEventListener("dragleave", e => { e.preventDefault(); dropArea.style.borderColor = "rgba(255,255,255,0.2)"; });
        dropArea.addEventListener("drop", e => { e.preventDefault(); dropArea.style.borderColor = "rgba(255,255,255,0.2)"; appendFiles(e.dataTransfer.files); });

        function appendFiles(files) {
            for (let i = 0; i < files.length; i++) dataTransfer.items.add(files[i]);
            fileInput.files = dataTransfer.files;
            updatePreviews();
        }

        window.removeNewFile = function(index) {
            let newDt = new DataTransfer();
            for (let i = 0; i < dataTransfer.files.length; i++) {
                if (i !== index) newDt.items.add(dataTransfer.files[i]);
            }
            dataTransfer = newDt;
            fileInput.files = dataTransfer.files;
            updatePreviews();
        };

        function updatePreviews() {
            previewArea.innerHTML = "";
            [...fileInput.files].forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const wrapper = document.createElement("div");
                    wrapper.style.position = "relative";
                    wrapper.style.width = "80px";
                    wrapper.style.height = "80px";
                    wrapper.style.border = "1px solid #7c3aed";
                    wrapper.style.borderRadius = "8px";

                    const img = document.createElement("img");
                    img.src = e.target.result;
                    img.style.width = "100%"; img.style.height = "100%"; img.style.objectFit = "cover"; img.style.borderRadius = "8px";

                    const removeBtn = document.createElement("div");
                    removeBtn.innerHTML = "<i class='fa-solid fa-xmark'></i>";
                    removeBtn.style.cssText = "position:absolute; top:-8px; right:-8px; background:#ef4444; color:#fff; width:22px; height:22px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:11px; z-index:10;";
                    removeBtn.onclick = function() { removeNewFile(index); };

                    wrapper.appendChild(img);
                    wrapper.appendChild(removeBtn);
                    previewArea.appendChild(wrapper);
                }
                reader.readAsDataURL(file);
            });
        }
    </script>
}