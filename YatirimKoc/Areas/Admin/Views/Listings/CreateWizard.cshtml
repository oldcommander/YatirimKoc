@model YatirimKoc.Web.Areas.Admin.Models.CreateListingWizardViewModel
@{
    Layout = "~/Areas/Admin/Views/Shared/AdminLayout.cshtml";
}

<div class="wizard">

    <div class="wizard-steps">
        <div class="step active" data-step="1">1. Temel Bilgiler</div>
        <div class="step" data-step="2">2. Konum</div>
        <div class="step" data-step="3">3. Özellikler</div>
        <div class="step" data-step="4">4. Görseller</div>
        <div class="step" data-step="5">5. Onay</div>
    </div>

    <form asp-action="CreateWizard" method="post" enctype="multipart/form-data" id="wizardForm" novalidate>
        <div asp-validation-summary="All" class="text-danger"></div>

        <div class="step-content active" data-step="1">
            <div class="form-grid">
                <div class="form-group">
                    <label asp-for="Title">İlan Başlığı</label>
                    <input asp-for="Title" class="input-dark" />
                    <span asp-validation-for="Title" class="text-danger"></span>
                </div>

                <div class="form-group">
                    <label asp-for="Price">Fiyat</label>
                    <input asp-for="Price" type="number" step="0.01" class="input-dark" />
                    <span asp-validation-for="Price" class="text-danger"></span>
                </div>

                <div class="form-group">
                    <label asp-for="TransactionTypeId">İşlem Tipi</label>
                    <select asp-for="TransactionTypeId" class="input-dark" asp-items="@(new SelectList(ViewBag.TransactionTypes, "Id", "Name"))">
                        <option value="">Seçiniz (Satılık/Kiralık)</option>
                    </select>
                    <span asp-validation-for="TransactionTypeId" class="text-danger"></span>
                </div>

                <div class="form-group">
                    <label asp-for="PropertyTypeId">Emlak Tipi</label>
                    <select asp-for="PropertyTypeId" class="input-dark" asp-items="@(new SelectList(ViewBag.PropertyTypes, "Id", "Name"))">
                        <option value="">Seçiniz (Konut/Arsa/İşyeri)</option>
                    </select>
                    <span asp-validation-for="PropertyTypeId" class="text-danger"></span>
                </div>

                <div class="form-group" style="grid-column: span 2;">
                    <label asp-for="Description">İlan Açıklaması</label>
                    <textarea asp-for="Description" class="input-dark" rows="4"></textarea>
                    <span asp-validation-for="Description" class="text-danger"></span>
                </div>
            </div>

            <div class="wizard-buttons">
                <button type="button" class="btn-primary" onclick="nextStep(1)">Devam Et →</button>
            </div>
        </div>

        <div class="step-content" data-step="2">
            <div class="form-grid">
                <div class="form-group">
                    <label asp-for="City">Şehir</label>
                    <select asp-for="City" class="input-dark" id="CitySelect">
                        <option value="Ankara" selected>Ankara</option>
                    </select>
                    <span asp-validation-for="City" class="text-danger"></span>
                </div>

                <div class="form-group">
                    <label asp-for="District">İlçe</label>
                    <select asp-for="District" class="input-dark" id="DistrictSelect">
                        <option value="">Önce Seçiniz...</option>
                    </select>
                    <span asp-validation-for="District" class="text-danger"></span>
                </div>

                <div class="form-group" style="grid-column: span 2;">
                    <label style="display:flex; justify-content:space-between;">
                        <span>Harita Konumu (İşaretlemek için tıklayın)</span>
                        <span id="coordDisplay" style="color:var(--accent-2); font-size:12px;">39.9334, 32.8597</span>
                    </label>

                    <div id="mapWrapper" style="height: 350px; border-radius: var(--radius-md); overflow: hidden; border: 1px solid var(--glass-border); background:rgba(0,0,0,0.3); z-index: 1;"></div>

                    <input type="hidden" asp-for="Latitude" id="Latitude" />
                    <input type="hidden" asp-for="Longitude" id="Longitude" />
                </div>
            </div>

            <div class="wizard-buttons">
                <button type="button" class="btn-secondary" onclick="prevStep(2)">← Geri</button>
                <button type="button" class="btn-primary" onclick="nextStep(2)">Devam Et →</button>
            </div>
        </div>

        <div class="step-content" data-step="3">
            <div class="form-grid">

                <div id="dynamicFeaturesContainer" style="grid-column: span 2; display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <p class="text-warning"><i>* Lütfen önce "Temel Bilgiler" adımından bir <b>Emlak Tipi</b> seçiniz. Özellikler seçiminize göre buraya yüklenecektir.</i></p>
                </div>

                <div class="form-group" style="grid-column: span 2; margin-top:20px;">
                    <hr style="border-color: rgba(255,255,255,0.1);" />
                    <label class="d-flex align-items-center mt-3">
                        <input asp-for="IsPublished" type="checkbox" style="width:20px; height:20px; margin-right:10px;" />
                        Bu ilanı anında yayına al (Taslak olarak kalmasın)
                    </label>
                </div>

            </div>

            <div class="wizard-buttons">
                <button type="button" class="btn-secondary" onclick="prevStep(3)">← Geri</button>
                <button type="button" class="btn-primary" onclick="nextStep(3)">Devam Et →</button>
            </div>
        </div>

        <div class="step-content" data-step="4">
            <div class="form-group">
                <label>Fotoğraf ve Videolar <small class="text-warning" style="margin-left:10px; font-style:italic;">(İlk sıradaki görsel ilan kapak fotoğrafı olacaktır)</small></label>
                <div class="upload-box" id="dropArea">
                    <p>Dosyaları sürükle bırak veya tıklayarak seç</p>
                    <input type="file" asp-for="Files" id="fileInput" multiple hidden accept="image/*,video/*" />
                </div>
                <div id="previewArea" class="preview-area"></div>
            </div>

            <div class="wizard-buttons">
                <button type="button" class="btn-secondary" onclick="prevStep(4)">← Geri</button>
                <button type="button" class="btn-primary" onclick="nextStep(4)">Devam Et →</button>
            </div>
        </div>

        <div class="step-content" data-step="5">
            <h3>Onayla ve Kaydet</h3>

            <div class="form-summary">
                <p><b>Başlık:</b> <span id="summaryTitle"></span></p>
                <p><b>Fiyat:</b> <span id="summaryPrice"></span></p>
                <p><b>İşlem Tipi:</b> <span id="summaryTransactionType"></span></p>
                <p><b>Emlak Tipi:</b> <span id="summaryPropertyType"></span></p>
                <p><b>Şehir:</b> <span id="summaryCity"></span></p>
                <p><b>İlçe:</b> <span id="summaryDistrict"></span></p>
            </div>

            <div class="wizard-buttons">
                <button type="button" class="btn-secondary" onclick="prevStep(5)">← Geri</button>
                <button type="submit" class="btn-primary">İlanı Kaydet</button>
            </div>
        </div>

    </form>
</div>

@section Scripts {
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        var validator;
                var map;
                var marker;

                $(function () {
                    // unobtrusive parse zorla
                    $.validator.unobtrusive.parse("#wizardForm");
                    validator = $("#wizardForm").data("validator");

                    // --- ANKARA İLÇELERİNİ DOLDUR ---
                    const ankaraDistricts = [
                        "Akyurt", "Altındağ", "Ayaş", "Bala", "Beypazarı", "Çamlıdere", "Çankaya", "Çubuk",
                        "Elmadağ", "Etimesgut", "Evren", "Gölbaşı", "Güdül", "Haymana", "Kahramankazan",
                        "Kalecik", "Keçiören", "Kızılcahamam", "Mamak", "Nallıhan", "Polatlı", "Pursaklar",
                        "Sincan", "Şereflikoçhisar", "Yenimahalle"
                    ];
                    const districtSelect = $("#DistrictSelect");
                    districtSelect.empty().append('<option value="">İlçe Seçiniz</option>');
                    ankaraDistricts.sort().forEach(d => {
                        districtSelect.append('<option value="' + d + '">' + d + '</option>');
                    });

                   // --- DOSYA YÜKLEME, BİRİKTİRME VE ÖNİZLEME (YENİ SİSTEM) ---
            const dropArea = document.getElementById("dropArea");
            const fileInput = document.getElementById("fileInput");
            const previewArea = document.getElementById("previewArea");

            // Üzerine yazmayı engellemek için dosyaları bu objede biriktiriyoruz
            let dataTransfer = new DataTransfer();

            dropArea.addEventListener("click", () => fileInput.click());

            fileInput.addEventListener("change", function () {
                appendFiles(this.files);
            });

            dropArea.addEventListener("dragover", e => {
                e.preventDefault();
                dropArea.style.borderColor = "#7c3aed";
            });

            dropArea.addEventListener("dragleave", e => {
                e.preventDefault();
                dropArea.style.borderColor = "rgba(255,255,255,0.2)";
            });

            dropArea.addEventListener("drop", e => {
                e.preventDefault();
                dropArea.style.borderColor = "rgba(255,255,255,0.2)";
                appendFiles(e.dataTransfer.files); // Sürüklenenleri ekle
            });

            // Gelen dosyaları listeye "ilave eden" fonksiyon
            function appendFiles(files) {
                for (let i = 0; i < files.length; i++) {
                    dataTransfer.items.add(files[i]);
                }
                fileInput.files = dataTransfer.files; // Gerçek inputu günceller (Form submit için)
                updatePreviews();
            }

            // Yanlışlıkla eklenen dosyayı listeden silen fonksiyon
            window.removeFile = function(index) {
                let newDt = new DataTransfer();
                for (let i = 0; i < dataTransfer.files.length; i++) {
                    if (i !== index) newDt.items.add(dataTransfer.files[i]); // Silinecek index hariç hepsini koru
                }
                dataTransfer = newDt;
                fileInput.files = dataTransfer.files;
                updatePreviews();
            };

            // Ekrana önizlemeleri çizen fonksiyon
            function updatePreviews() {
                previewArea.innerHTML = "";
                const files = fileInput.files;

                [...files].forEach((file, index) => {
                    const reader = new FileReader();
                    reader.onload = function (e) {

                        // Her bir medya elemanını kapsayacak kutu
                        const wrapper = document.createElement("div");
                        wrapper.style.position = "relative";
                        wrapper.style.display = "inline-block";

                        // Medya Tipi (Video mu, Resim mi?)
                        let mediaElement;
                        if(file.type.startsWith("video/")) {
                            mediaElement = document.createElement("video");
                            mediaElement.src = e.target.result;
                            mediaElement.className = "preview-img";
                            mediaElement.controls = true;
                        } else {
                            mediaElement = document.createElement("img");
                            mediaElement.src = e.target.result;
                            mediaElement.className = "preview-img";
                        }

                        // KAPAK FOTOĞRAFI VURGUSU (Sadece ilk sıradaki öğe)
                        if(index === 0) {
                            mediaElement.style.borderColor = "var(--accent-2)";
                            mediaElement.style.borderWidth = "3px";

                            const badge = document.createElement("div");
                            badge.innerText = "Kapak Görseli";
                            badge.style.position = "absolute";
                            badge.style.bottom = "10px";
                            badge.style.left = "50%";
                            badge.style.transform = "translateX(-50%)";
                            badge.style.backgroundColor = "var(--accent-2)";
                            badge.style.color = "#000";
                            badge.style.padding = "3px 8px";
                            badge.style.borderRadius = "20px";
                            badge.style.fontSize = "11px";
                            badge.style.fontWeight = "bold";
                            badge.style.zIndex = "10";
                            badge.style.boxShadow = "0 2px 5px rgba(0,0,0,0.5)";
                            wrapper.appendChild(badge);
                        }

                        // SİLME (X) BUTONU
                        const removeBtn = document.createElement("div");
                        removeBtn.innerHTML = "<i class='fa-solid fa-xmark'></i>";
                        removeBtn.style.position = "absolute";
                        removeBtn.style.top = "-8px";
                        removeBtn.style.right = "-8px";
                        removeBtn.style.backgroundColor = "#ef4444";
                        removeBtn.style.color = "#fff";
                        removeBtn.style.width = "24px";
                        removeBtn.style.height = "24px";
                        removeBtn.style.borderRadius = "50%";
                        removeBtn.style.display = "flex";
                        removeBtn.style.alignItems = "center";
                        removeBtn.style.justifyContent = "center";
                        removeBtn.style.cursor = "pointer";
                        removeBtn.style.fontSize = "12px";
                        removeBtn.style.zIndex = "10";
                        removeBtn.style.boxShadow = "0 2px 5px rgba(0,0,0,0.4)";
                        removeBtn.onclick = function() { removeFile(index); };

                        wrapper.appendChild(mediaElement);
                        wrapper.appendChild(removeBtn);
                        previewArea.appendChild(wrapper);
                    }
                    reader.readAsDataURL(file);
                });
            }

                    // --- DİNAMİK ÖZELLİKLER (AJAX) ---
                    $("#PropertyTypeId").on("change", function () {
                        var propertyTypeId = $(this).val();
                        var container = $("#dynamicFeaturesContainer");

                        if (!propertyTypeId) {
                            container.html('<p class="text-warning" style="grid-column: span 2;"><i>* Lütfen önce "Temel Bilgiler" adımından bir Emlak Tipi seçiniz.</i></p>');
                            return;
                        }

                        container.html('<p class="text-muted" style="grid-column: span 2;">Özellikler yükleniyor...</p>');

                        $.get("/Admin/Listings/GetFeatures?propertyTypeId=" + propertyTypeId, function (data) {
                            container.empty();

                            if (data.length === 0) {
                                container.html('<p class="text-muted" style="grid-column: span 2;">Bu emlak tipine ait tanımlı ekstra özellik bulunmuyor.</p>');
                                return;
                            }

                            data.forEach(function (feature) {
                                var html = '<div class="form-group">';
                                var reqMark = feature.isRequired ? ' <span class="text-danger">*</span>' : '';
                                html += '<label>' + feature.name + reqMark + '</label>';

                                var inputName = 'FeatureValues[' + feature.id + ']';
                                var requiredAttr = feature.isRequired ? 'required="required"' : '';

                                if (feature.inputType === "Select") {
                                    html += '<select name="' + inputName + '" class="input-dark" ' + requiredAttr + '>';
                                    html += '<option value="">Seçiniz</option>';
                                    if (feature.options) {
                                        var optionsArray = feature.options.split(',');
                                        optionsArray.forEach(function(opt) {
                                            html += '<option value="' + opt.trim() + '">' + opt.trim() + '</option>';
                                        });
                                    }
                                    html += '</select>';
                                }
                                else if (feature.inputType === "Number") {
                                    html += '<input type="number" name="' + inputName + '" class="input-dark" ' + requiredAttr + ' />';
                                }
                                else {
                                    html += '<input type="text" name="' + inputName + '" class="input-dark" ' + requiredAttr + ' />';
                                }

                                html += '</div>';
                                container.append(html);
                            });

                            // ÇÖZÜM BURADA: DOM'a yeni elemanlar eklendikten sonra Form Validator'ü baştan kuruyoruz!
                            var form = $("#wizardForm");
                            form.removeData("validator").removeData("unobtrusiveValidation");
                            $.validator.unobtrusive.parse(form);
                            validator = form.data("validator");

                        }).fail(function() {
                            container.html('<p class="text-danger" style="grid-column: span 2;">Özellikler yüklenirken bir hata oluştu.</p>');
                        });
                    });
                });

                // --- HARİTAYI BAŞLATMA FONKSİYONU ---
        function initMap() {
            if (map) return;
            const defaultLat = 39.9334;
            const defaultLng = 32.8597;

            map = L.map('mapWrapper').setView([defaultLat, defaultLng], 11);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap &copy; CARTO',
                subdomains: 'abcd',
                maxZoom: 20
            }).addTo(map);

            marker = L.marker([defaultLat, defaultLng]).addTo(map);

            // ÇÖZÜM 1: İlk yüklemede noktaları virgüle çevir
            $("#Latitude").val(defaultLat.toString().replace('.', ','));
            $("#Longitude").val(defaultLng.toString().replace('.', ','));

            map.on('click', function(e) {
                const lat = e.latlng.lat;
                const lng = e.latlng.lng;

                marker.setLatLng([lat, lng]);

                // ÇÖZÜM 2: Haritaya tıklandığında noktaları virgüle çevirerek inputa yaz
                $("#Latitude").val(lat.toString().replace('.', ','));
                $("#Longitude").val(lng.toString().replace('.', ','));

                $("#coordDisplay").text(lat.toFixed(4) + ", " + lng.toFixed(4));
            });
        }

                // --- WIZARD İŞLEMLERİ VE GÜÇLENDİRİLMİŞ DOĞRULAMA ---
                function nextStep(step) {
                    if (!validateStep(step)) return;
                    if(step === 4) updateSummary();
                    changeStep(step, step + 1);
                    markStepComplete(step);
                }

                function prevStep(step) {
                    changeStep(step, step - 1);
                }

                function validateStep(step) {
                    var currentSection = $(".step-content[data-step='" + step + "']");
                    // Gizli(hidden) inputları dışla, form elemanlarını seç
                    var inputs = currentSection.find("input:not([type=hidden]), select, textarea");
                    var isValid = true;

                    inputs.each(function() {
                        var el = this;

                        // 1. Manuel (Native HTML5) Kontrol (AJAX ile gelenler için)
                        if (el.hasAttribute('required') && !el.value) {
                            isValid = false;
                            $(el).css("border-color", "#f43f5e"); // Hata görseli (Kırmızı Çerçeve)
                        } else {
                            $(el).css("border-color", "rgba(255, 255, 255, 0.1)"); // Normal çerçeve
                        }

                        // 2. jQuery Validation Kontrolü
                        if (validator && $(el).attr('name')) {
                            try {
                                if (!validator.element(el)) {
                                    isValid = false;
                                }
                            } catch(e) {
                                // Doğrulayıcı elemanı tanımazsa çökmeyi engelle
                            }
                        }
                    });

                    return isValid;
                }

                function changeStep(oldStep, newStep) {
                    $(".step-content").removeClass("active");
                    $(".step-content[data-step='" + newStep + "']").addClass("active");

                    $(".step").removeClass("active");
                    $(".step[data-step='" + newStep + "']").addClass("active");

                    if(newStep === 2) {
                        setTimeout(function() {
                            initMap();
                            map.invalidateSize();
                        }, 200);
                    }
                }

                function markStepComplete(step) {
                    $(".step[data-step='" + step + "']").addClass("completed");
                }

                function updateSummary() {
                    $("#summaryTitle").text($("#Title").val());
                    $("#summaryPrice").text($("#Price").val());
                    $("#summaryTransactionType").text($("#TransactionTypeId option:selected").text());
                    $("#summaryPropertyType").text($("#PropertyTypeId option:selected").text());
                    $("#summaryCity").text($("#CitySelect option:selected").text());
                    $("#summaryDistrict").text($("#DistrictSelect option:selected").text());
                }
    </script>
}