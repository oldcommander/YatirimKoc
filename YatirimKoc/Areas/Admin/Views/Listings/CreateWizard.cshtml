@model YatirimKoc.Web.Areas.Admin.Models.CreateListingWizardViewModel
@{
    Layout = "~/Areas/Admin/Views/Shared/AdminLayout.cshtml";
}

<div class="wizard">

    <div class="wizard-steps">
        <div class="step active" data-step="1">1. Temel Bilgiler</div>
        <div class="step" data-step="2">2. Konum</div>
        <div class="step" data-step="3">3. Özellikler</div>
        <div class="step" data-step="4">4. Görseller</div>
        <div class="step" data-step="5">5. Onay</div>
    </div>

    <form asp-action="CreateWizard" method="post" enctype="multipart/form-data" id="wizardForm" novalidate>
        <div asp-validation-summary="All" class="text-danger"></div>

        <div class="step-content active" data-step="1">
            <div class="form-grid">
                <div class="form-group">
                    <label asp-for="Title">İlan Başlığı</label>
                    <input asp-for="Title" class="input-dark" />
                    <span asp-validation-for="Title" class="text-danger"></span>
                </div>

                <div class="form-group">
                    <label asp-for="Price">Fiyat</label>
                    <input asp-for="Price" type="number" step="0.01" class="input-dark" />
                    <span asp-validation-for="Price" class="text-danger"></span>
                </div>

                <div class="form-group">
                    <label asp-for="TransactionTypeId">İşlem Tipi</label>
                    <select asp-for="TransactionTypeId" class="input-dark" asp-items="@(new SelectList(ViewBag.TransactionTypes, "Id", "Name"))">
                        <option value="">Seçiniz (Satılık/Kiralık)</option>
                    </select>
                    <span asp-validation-for="TransactionTypeId" class="text-danger"></span>
                </div>

                <div class="form-group">
                    <label asp-for="PropertyTypeId">Emlak Tipi</label>
                    <select asp-for="PropertyTypeId" class="input-dark" asp-items="@(new SelectList(ViewBag.PropertyTypes, "Id", "Name"))">
                        <option value="">Seçiniz (Konut/Arsa/İşyeri)</option>
                    </select>
                    <span asp-validation-for="PropertyTypeId" class="text-danger"></span>
                </div>

                <div class="form-group" style="grid-column: span 2;">
                    <label asp-for="Description">İlan Açıklaması</label>
                    <textarea asp-for="Description" class="input-dark" rows="4"></textarea>
                    <span asp-validation-for="Description" class="text-danger"></span>
                </div>
            </div>

            <div class="wizard-buttons">
                <button type="button" class="btn-primary" onclick="nextStep(1)">Devam Et →</button>
            </div>
        </div>

        <div class="step-content" data-step="2">
            <div class="form-grid">
                <div class="form-group">
                    <label asp-for="City">Şehir</label>
                    <input asp-for="City" class="input-dark" />
                    <span asp-validation-for="City" class="text-danger"></span>
                </div>

                <div class="form-group">
                    <label asp-for="District">İlçe</label>
                    <input asp-for="District" class="input-dark" />
                    <span asp-validation-for="District" class="text-danger"></span>
                </div>
            </div>

            <div class="wizard-buttons">
                <button type="button" class="btn-secondary" onclick="prevStep(2)">← Geri</button>
                <button type="button" class="btn-primary" onclick="nextStep(2)">Devam Et →</button>
            </div>
        </div>

        <div class="step-content" data-step="3">
            <div class="form-grid">

                <div class="form-group" style="grid-column: span 2;">
                    <p class="text-warning"><i>* Bu ekrandaki detaylı özellikler (Oda Sayısı, İmar Durumu vs.), "Temel Bilgiler" adımında seçtiğiniz <b>Emlak Tipi</b>'ne göre dinamik olarak yüklenecektir. (AJAX Entegrasyonu Bekleniyor)</i></p>
                </div>

                <div class="form-group">
                    <label asp-for="IsPublished">Yayında mı?</label>
                    <input asp-for="IsPublished" type="checkbox" />
                </div>
            </div>

            <div class="wizard-buttons">
                <button type="button" class="btn-secondary" onclick="prevStep(3)">← Geri</button>
                <button type="button" class="btn-primary" onclick="nextStep(3)">Devam Et →</button>
            </div>
        </div>

        <div class="step-content" data-step="4">
            <div class="form-group">
                <label>Fotoğraflar</label>
                <div class="upload-box" id="dropArea">
                    <p>Dosyaları sürükle bırak veya tıkla</p>
                    <input type="file" asp-for="Files" id="fileInput" multiple hidden />
                </div>
                <div id="previewArea" class="preview-area"></div>
            </div>

            <div class="wizard-buttons">
                <button type="button" class="btn-secondary" onclick="prevStep(4)">← Geri</button>
                <button type="button" class="btn-primary" onclick="nextStep(4)">Devam Et →</button>
            </div>
        </div>

        <div class="step-content" data-step="5">
            <h3>Onayla ve Kaydet</h3>

            <div class="form-summary">
                <p><b>Başlık:</b> <span id="summaryTitle"></span></p>
                <p><b>Fiyat:</b> <span id="summaryPrice"></span></p>
                <p><b>İşlem Tipi:</b> <span id="summaryTransactionType"></span></p>
                <p><b>Emlak Tipi:</b> <span id="summaryPropertyType"></span></p>
                <p><b>Şehir:</b> <span id="summaryCity"></span></p>
                <p><b>İlçe:</b> <span id="summaryDistrict"></span></p>
            </div>

            <div class="wizard-buttons">
                <button type="button" class="btn-secondary" onclick="prevStep(5)">← Geri</button>
                <button type="submit" class="btn-primary">İlanı Kaydet</button>
            </div>
        </div>

    </form>
</div>

@section Scripts {
    <script>
        var validator;
        $(function () {
            // unobtrusive parse zorla
            $.validator.unobtrusive.parse("#wizardForm");
            validator = $("#wizardForm").data("validator");

            // preview image
            const dropArea = document.getElementById("dropArea");
            const fileInput = document.getElementById("fileInput");
            const previewArea = document.getElementById("previewArea");

            dropArea.addEventListener("click", () => fileInput.click());

            fileInput.addEventListener("change", function () {
                handleFiles(this.files);
            });

            dropArea.addEventListener("dragover", e => {
                e.preventDefault();
                dropArea.style.borderColor = "#7c3aed";
            });

            dropArea.addEventListener("dragleave", e => {
                e.preventDefault();
                dropArea.style.borderColor = "rgba(255,255,255,0.2)";
            });

            dropArea.addEventListener("drop", e => {
                e.preventDefault();
                fileInput.files = e.dataTransfer.files;
                handleFiles(e.dataTransfer.files);
            });

            function handleFiles(files) {
                previewArea.innerHTML = "";
                [...files].forEach(file => {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const img = document.createElement("img");
                        img.src = e.target.result;
                        img.className = "preview-img";
                        previewArea.appendChild(img);
                    }
                    reader.readAsDataURL(file);
                });
            }
        });

        function nextStep(step) {
            if (!validateStep(step)) return;
            if(step === 4) updateSummary();
            changeStep(step, step + 1);
            markStepComplete(step);
        }

        function prevStep(step) {
            changeStep(step, step - 1);
        }

        function validateStep(step) {
            var currentSection = $(".step-content[data-step='" + step + "']");
            var inputs = currentSection.find("input, select, textarea");
            var isValid = true;
            inputs.each(function() {
                if (!validator.element(this)) isValid = false;
            });
            return isValid;
        }

        function changeStep(oldStep, newStep) {
            $(".step-content").removeClass("active");
            $(".step-content[data-step='" + newStep + "']").addClass("active");

            $(".step").removeClass("active");
            $(".step[data-step='" + newStep + "']").addClass("active");
        }

        function markStepComplete(step) {
            $(".step[data-step='" + step + "']").addClass("completed");
        }

        function updateSummary() {
            $("#summaryTitle").text($("#Title").val());
            $("#summaryPrice").text($("#Price").val());
            $("#summaryTransactionType").text($("#TransactionTypeId option:selected").text());
            $("#summaryPropertyType").text($("#PropertyTypeId option:selected").text());
            $("#summaryCity").text($("#City").val());
            $("#summaryDistrict").text($("#District").val());
        }
    </script>
}