@model CreateListingWizardViewModel
@{
    Layout = "~/Areas/Admin/Views/Shared/AdminLayout.cshtml";
}

<div class="wizard">

    <!-- STEP INDICATOR -->
    <div class="wizard-steps">
        <div class="step active" data-step="1">1. Temel Bilgiler</div>
        <div class="step" data-step="2">2. Konum</div>
        <div class="step" data-step="3">3. Özellikler</div>
        <div class="step" data-step="4">4. Görseller</div>
        <div class="step" data-step="5">5. Onay</div>
    </div>

    <form asp-action="CreateWizard" method="post" enctype="multipart/form-data" id="wizardForm" novalidate>
        <div asp-validation-summary="All" class="text-danger"></div>

        <!-- STEP 1: Temel Bilgiler -->
        <div class="step-content active" data-step="1">
            <div class="form-grid">
                <div class="form-group">
                    <label asp-for="Title">İlan Başlığı</label>
                    <input asp-for="Title" class="input-dark" />
                    <span asp-validation-for="Title" class="text-danger"></span>
                </div>

                <div class="form-group">
                    <label asp-for="Price">Fiyat</label>
                    <input asp-for="Price" type="number" step="0.01" class="input-dark" />
                    <span asp-validation-for="Price" class="text-danger"></span>
                </div>

                <div class="form-group">
                    <label asp-for="ListingCategoryId">Kategori</label>
                    <select asp-for="ListingCategoryId" class="input-dark"
                            asp-items="@(new SelectList(ViewBag.Categories, "Id", "Name"))">
                        <option value="">Seçiniz</option>
                    </select>
                    <span asp-validation-for="ListingCategoryId" class="text-danger"></span>
                </div>

                <div class="form-group">
                    <label asp-for="ListingTypeId">İlan Tipi</label>
                    <select asp-for="ListingTypeId" class="input-dark"
                            asp-items="@(new SelectList(ViewBag.Types, "Id", "Name"))">
                        <option value="">Seçiniz</option>
                    </select>
                    <span asp-validation-for="ListingTypeId" class="text-danger"></span>
                </div>
            </div>

            <div class="wizard-buttons">
                <button type="button" class="btn-primary" onclick="nextStep(1)">Devam Et →</button>
            </div>
        </div>

        <!-- STEP 2: Konum -->
        <div class="step-content" data-step="2">
            <div class="form-grid">
                <div class="form-group">
                    <label asp-for="City">Şehir</label>
                    <input asp-for="City" class="input-dark" />
                    <span asp-validation-for="City" class="text-danger"></span>
                </div>

                <div class="form-group">
                    <label asp-for="District">İlçe</label>
                    <input asp-for="District" class="input-dark" />
                    <span asp-validation-for="District" class="text-danger"></span>
                </div>
            </div>

            <div class="wizard-buttons">
                <button type="button" class="btn-secondary" onclick="prevStep(2)">← Geri</button>
                <button type="button" class="btn-primary" onclick="nextStep(2)">Devam Et →</button>
            </div>
        </div>

        <!-- STEP 3: Özellikler -->
        <div class="step-content" data-step="3">
            <div class="form-grid">
                <div class="form-group">
                    <label asp-for="Bedrooms">Oda Sayısı</label>
                    <input asp-for="Bedrooms" type="number" class="input-dark" />
                    <span asp-validation-for="Bedrooms" class="text-danger"></span>
                </div>

                <div class="form-group">
                    <label asp-for="Bathrooms">Banyo Sayısı</label>
                    <input asp-for="Bathrooms" type="number" class="input-dark" />
                    <span asp-validation-for="Bathrooms" class="text-danger"></span>
                </div>

                <div class="form-group">
                    <label asp-for="Area">Alan (m²)</label>
                    <input asp-for="Area" type="number" class="input-dark" />
                    <span asp-validation-for="Area" class="text-danger"></span>
                </div>

                <div class="form-group">
                    <label asp-for="IsPublished">Yayında mı?</label>
                    <input asp-for="IsPublished" type="checkbox" />
                </div>
            </div>

            <div class="wizard-buttons">
                <button type="button" class="btn-secondary" onclick="prevStep(3)">← Geri</button>
                <button type="button" class="btn-primary" onclick="nextStep(3)">Devam Et →</button>
            </div>
        </div>

        <!-- STEP 4: Görseller -->
        <div class="step-content" data-step="4">
            <div class="form-group">
                <label>Fotoğraflar</label>
                <div class="upload-box" id="dropArea">
                    <p>Dosyaları sürükle bırak veya tıkla</p>
                    <input type="file" asp-for="Files" id="fileInput" multiple hidden />
                </div>
                <div id="previewArea" class="preview-area"></div>
            </div>

            <div class="wizard-buttons">
                <button type="button" class="btn-secondary" onclick="prevStep(4)">← Geri</button>
                <button type="button" class="btn-primary" onclick="nextStep(4)">Devam Et →</button>
            </div>
        </div>

        <!-- STEP 5: Onay -->
        <div class="step-content" data-step="5">
            <h3>Onayla ve Kaydet</h3>

            <div class="form-summary">
                <p><b>Başlık:</b> <span id="summaryTitle"></span></p>
                <p><b>Fiyat:</b> <span id="summaryPrice"></span></p>
                <p><b>Kategori:</b> <span id="summaryCategory"></span></p>
                <p><b>Tip:</b> <span id="summaryType"></span></p>
                <p><b>Şehir:</b> <span id="summaryCity"></span></p>
                <p><b>İlçe:</b> <span id="summaryDistrict"></span></p>
            </div>

            <div class="wizard-buttons">
                <button type="button" class="btn-secondary" onclick="prevStep(5)">← Geri</button>
                <button type="submit" class="btn-primary">Kaydet</button>
            </div>
        </div>

    </form>
</div>

@section Scripts {
    <script>
        var validator;

        $(function () {
            // unobtrusive parse zorla
            $.validator.unobtrusive.parse("#wizardForm");
            validator = $("#wizardForm").data("validator");

            // preview image
            const dropArea = document.getElementById("dropArea");
            const fileInput = document.getElementById("fileInput");
            const previewArea = document.getElementById("previewArea");

            dropArea.addEventListener("click", () => fileInput.click());

            fileInput.addEventListener("change", function () {
                handleFiles(this.files);
            });

            dropArea.addEventListener("dragover", e => {
                e.preventDefault();
                dropArea.style.borderColor = "#7c3aed";
            });

            dropArea.addEventListener("dragleave", e => {
                e.preventDefault();
                dropArea.style.borderColor = "rgba(255,255,255,0.2)";
            });

            dropArea.addEventListener("drop", e => {
                e.preventDefault();
                fileInput.files = e.dataTransfer.files;
                handleFiles(e.dataTransfer.files);
            });

            function handleFiles(files) {
                previewArea.innerHTML = "";
                [...files].forEach(file => {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const img = document.createElement("img");
                        img.src = e.target.result;
                        img.className = "preview-img";
                        previewArea.appendChild(img);
                    }
                    reader.readAsDataURL(file);
                });
            }
        });

        function nextStep(step) {
            if (!validateStep(step)) return;

            // update summary for step5
            if(step === 4) updateSummary();

            changeStep(step, step + 1);
            markStepComplete(step);
        }

        function prevStep(step) {
            changeStep(step, step - 1);
        }

        function validateStep(step) {
            var currentSection = $(".step-content[data-step='" + step + "']");
            var inputs = currentSection.find("input, select, textarea");
            var isValid = true;
            inputs.each(function() {
                if (!validator.element(this)) isValid = false;
            });
            return isValid;
        }

        function changeStep(oldStep, newStep) {
            $(".step-content").removeClass("active");
            $(".step-content[data-step='" + newStep + "']").addClass("active");

            $(".step").removeClass("active");
            $(".step[data-step='" + newStep + "']").addClass("active");
        }

        function markStepComplete(step) {
            $(".step[data-step='" + step + "']").addClass("completed");
        }

        function updateSummary() {
            $("#summaryTitle").text($("#Title").val());
            $("#summaryPrice").text($("#Price").val());
            $("#summaryCategory").text($("#ListingCategoryId option:selected").text());
            $("#summaryType").text($("#ListingTypeId option:selected").text());
            $("#summaryCity").text($("#City").val());
            $("#summaryDistrict").text($("#District").val());
        }
    </script>
}
