@using YatirimKoc.Domain.Entities.Identity
@using Microsoft.AspNetCore.Identity
@inject UserManager<User> UserManager

@{
    var currentUser = await UserManager.GetUserAsync(User);
    var roles = currentUser != null ? await UserManager.GetRolesAsync(currentUser) : new List<string>();
    var roleName = roles.FirstOrDefault() ?? "Admin";

    var currentController = ViewContext.RouteData.Values["controller"]?.ToString() ?? "";
    var currentAction = ViewContext.RouteData.Values["action"]?.ToString() ?? "";
}

<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - YatırımKoç Yönetim Paneli</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />

    <link rel="stylesheet" href="~/css/admin.css" asp-append-version="true" />

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="bg-mesh"></div>

    <div class="app">
        <nav class="sidebar">

            <div class="brand">
                <div class="logo"><i class="fa-solid fa-chart-line"></i></div>
                <div class="title">YatırımKoç</div>
            </div>

            <div class="sidebar-scroll">
                <ul class="nav">
                    <li>
                        <a href="/admin/dashboard" class="@(currentController.ToLower() == "dashboard" ? "active" : "")">
                            <span class="icon"><i class="fa-solid fa-house-chimney"></i></span>
                            <span class="label">Genel Bakış</span>
                        </a>
                    </li>

                    @if (User.IsInRole(RoleConstants.SuperAdmin))
                    {
                        <li class="has-children @(currentController.ToLower() == "users" ? "expanded active" : "")">
                            <a href="#">
                                <span class="icon"><i class="fa-solid fa-users"></i></span>
                                <span class="label">Kullanıcılar</span>
                            </a>
                            <ul class="submenu">
                                <li><a asp-area="Admin" asp-controller="Users" asp-action="Index" class="@(currentAction.ToLower() == "index" && currentController.ToLower() == "users" ? "text-glow" : "")">Tüm Kullanıcılar</a></li>
                                <li><a asp-area="Admin" asp-controller="Users" asp-action="Create" class="@(currentAction.ToLower() == "create" && currentController.ToLower() == "users" ? "text-glow" : "")">Yeni Danışman Ekle</a></li>
                            </ul>
                        </li>
                    }

                    <li class="has-children @(currentController.ToLower() == "listings" ? "expanded active" : "")">
                        <a href="#">
                            <span class="icon"><i class="fa-solid fa-building"></i></span>
                            <span class="label">İlanlar</span>
                        </a>
                        <ul class="submenu">
                            <li><a asp-area="Admin" asp-controller="Listings" asp-action="Index">Tüm İlanlar</a></li>
                            <li><a asp-area="Admin" asp-controller="Listings" asp-action="CreateWizard" class="text-glow">Yeni İlan Ekle</a></li>
                        </ul>
                    </li>

                    <li class="has-children @(currentController.ToLower() == "sitesettings" ? "expanded active" : "")">
                        <a href="#">
                            <span class="icon"><i class="fa-solid fa-cog"></i></span>
                            <span class="label">Ayarlar</span>
                        </a>
                        <ul class="submenu">
                            <li><a asp-area="Admin" asp-controller="SiteSettings" asp-action="Index">Site Ayarları</a></li>
                        </ul>
                    </li>

                    <li class="has-children @(currentController.ToLower() == "contactmessages" ? "expanded active" : "")">
                        <a href="#">
                            <span class="icon"><i class="fa-solid fa-comment-dots"></i></span>
                            <span class="label">Mesajlar</span>
                        </a>
                        <ul class="submenu">
                            <li><a asp-area="Admin" asp-controller="ContactMessages" asp-action="Index">Tüm Mesajlar</a></li>
                        </ul>
                    </li>

                    <li class="has-children @(currentController.ToLower() == "reservations" ? "expanded active" : "")">
                        <a href="#">
                            <span class="icon"><i class="fa-solid fa-calendar"></i></span>
                            <span class="label">Rezervasyonlar</span>
                        </a>
                        <ul class="submenu">
                            <li><a asp-area="Admin" asp-controller="Reservations" asp-action="Index">Tüm Rezervasyonlar</a></li>
                        </ul>
                    </li>
                    <li class="has-children @(currentController.ToLower() == "mails" || currentController.ToLower() == "newslettersubscribers" ? "expanded active" : "")">
                        <a href="#">
                            <span class="icon"><i class="fa-solid fa-envelope"></i></span>
                            <span class="label">Mail İşlemleri</span>
                        </a>
                        <ul class="submenu">
                            <li><a asp-area="Admin" asp-controller="Mails" asp-action="Index">Tüm Şablonlar</a></li>
                            <li><a asp-area="Admin" asp-controller="Mails" asp-action="Create">Yeni Şablon Ekle</a></li>

                            <li style="padding: 15px 20px 5px 20px; font-size: 11px; text-transform: uppercase; color: var(--muted); font-weight: 700; letter-spacing: 0.5px; opacity: 0.7;">
                                Bülten İşlemleri
                            </li>
                            <li><a asp-area="Admin" asp-controller="NewsletterSubscribers" asp-action="Index">Bülten Aboneleri</a></li>
                            <li><a asp-area="Admin" asp-controller="NewsletterSubscribers" asp-action="SendBulk">Toplu Mail Gönder</a></li>
                            <li><a asp-area="Admin" asp-controller="NewsletterSubscribers" asp-action="MailLogs">Mail Gönderim Logları</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </nav>

        <main class="main">
            <header class="topbar glass-panel">
                <div class="left">
                    <button class="hamburger"><i class="fa-solid fa-bars-staggered"></i></button>
                    <div class="searchwide">
                        <i class="fa-solid fa-magnifying-glass" style="color:var(--muted); margin-right:10px;"></i>
                        <input type="text" placeholder="Panelde ara..." />
                    </div>
                </div>

                <div class="right">
                    <button class="icon-btn" id="logoutBtn" title="Çıkış Yap">
                        <i class="fa-solid fa-power-off"></i>
                    </button>

                    <div class="user-profile">
                        <div class="user-info">
                            <div class="user-name">@currentUser?.FirstName @currentUser?.LastName</div>
                            <div class="user-role">@roleName</div>
                        </div>

                        <div class="avatar">
                            @if (!string.IsNullOrEmpty(currentUser?.AdminProfile?.ProfileImageUrl))
                            {
                                <img src="@currentUser.AdminProfile.ProfileImageUrl" alt="Profile" />
                            }
                            else
                            {
                                <div class="avatar-placeholder"><i class="fa-solid fa-user-astronaut"></i></div>
                            }
                        </div>
                    </div>
                </div>
            </header>

            <div class="content fade-in-up">
                @RenderBody()
            </div>
        </main>
    </div>

    <div id="logoutModal" class="modal-overlay" style="display:none;">
        <div class="modal-box glass-panel">
            <h3 style="color:#ff4d4d; display:flex; align-items:center; gap:10px; justify-content:center;">
                <div class="icon-circle-danger" style="background:rgba(239,68,68,0.1); width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center;"><i class="fa-solid fa-triangle-exclamation"></i></div>
                Çıkış Yap
            </h3>
            <p style="margin: 15px 0; color: var(--muted); text-align:center;">Oturumu kapatmak istediğinize emin misiniz? Kaydedilmemiş verileriniz kaybolabilir.</p>

            <div style="display:flex;justify-content:center;gap:15px; margin-top:25px;">
                <button id="cancelLogoutBtn" class="btn-secondary" style="flex:1;">Vazgeç</button>
                <form method="post" asp-area="Admin" asp-controller="Auth" asp-action="Logout" style="margin:0; flex:1;">
                    <button type="submit" class="btn-primary" style="width:100%; background: linear-gradient(135deg, #ef4444, #b91c1c); box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);">Evet, Çıkış Yap</button>
                </form>
            </div>
        </div>
    </div>

    <button id="scrollTopBtn" class="glow-effect">
        <i class="fa-solid fa-arrow-up"></i>
    </button>

    <script src="~/lib/jquery/dist/jquery.js"></script>
    <script src="~/lib/jquery-validation/dist/jquery.validate.js"></script>
    <script src="~/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const sidebar = document.querySelector('.sidebar');
            const hamburger = document.querySelector('.hamburger');
            const collapseBreakpoint = 900;

            hamburger.addEventListener('click', () => {
                if (window.innerWidth <= collapseBreakpoint) {
                    sidebar.classList.toggle('open');
                } else {
                    sidebar.classList.toggle('collapsed');
                }
            });

            document.querySelectorAll('.has-children > a').forEach(link => {
                link.addEventListener('click', function (e) {
                    e.preventDefault();
                    const parent = this.parentElement;

                    document.querySelectorAll('.has-children').forEach(item => {
                        if (item !== parent) item.classList.remove('expanded');
                    });

                    parent.classList.toggle('expanded');
                });
            });

            const scrollBtn = document.getElementById("scrollTopBtn");
            window.addEventListener("scroll", () => {
                if (window.scrollY > 200) {
                    scrollBtn.classList.add("show");
                } else {
                    scrollBtn.classList.remove("show");
                }
            });

            scrollBtn.addEventListener("click", () => {
                window.scrollTo({ top: 0, behavior: "smooth" });
            });

            const logoutBtn = document.getElementById('logoutBtn');
            const logoutModal = document.getElementById('logoutModal');
            const cancelLogout = document.getElementById('cancelLogoutBtn');

            if(logoutBtn) logoutBtn.addEventListener('click', () => logoutModal.style.display = 'flex');
            if(cancelLogout) cancelLogout.addEventListener('click', () => logoutModal.style.display = 'none');

            if(logoutModal){
                logoutModal.addEventListener('click', (e) => {
                    if (e.target === logoutModal) logoutModal.style.display = 'none';
                });
            }
        });
    </script>

    @RenderSection("Scripts", required: false)
</body>
</html>