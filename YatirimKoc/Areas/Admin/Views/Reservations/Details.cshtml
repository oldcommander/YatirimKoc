@using YatirimKoc.Domain.Enums
@model YatirimKoc.Application.Features.Reservations.Dtos.ReservationDto
@{
    ViewData["Title"] = "Randevu Detayı";
    Layout = "~/Areas/Admin/Views/Shared/AdminLayout.cshtml";
}

<div class="fade-in-up">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 25px;">
        <h2 style="margin:0; font-weight:800; letter-spacing:-0.5px; color:#fff;">Randevu Detayı</h2>
        <a asp-action="Index" class="btn-secondary" style="text-decoration:none;">
            <i class="fas fa-arrow-left me-2"></i> Geri Dön
        </a>
    </div>

    <div class="row">
        <div class="col-xl-8 col-lg-10 mx-auto">
            <div class="glass-panel" style="border-radius: var(--radius-lg); padding: 30px; border-top: 5px solid var(--accent-1);">

                <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:25px;">
                    <div>
                        <h4 style="color:var(--accent-2); font-weight:800; margin-bottom:5px;">
                            <i class="fa-regular fa-calendar-check me-2"></i>@Model.ReservationDate.ToString("dd MMMM yyyy")
                        </h4>
                        <div style="color:var(--muted); font-size:15px; font-weight:600;">
                            <i class="fa-regular fa-clock me-1"></i> @Model.TimeSlot
                        </div>
                    </div>
                    <div id="statusBadgeContainer">
                        @switch (Model.Status)
                        {
                            case ReservationStatus.Pending:
                                <div class="status-pill status-draft"><i class="fas fa-hourglass-half"></i> Bekliyor</div>
                                break;
                            case ReservationStatus.Approved:
                                <div class="status-pill status-active"><i class="fas fa-check-circle"></i> Onaylandı</div>
                                break;
                            case ReservationStatus.Rejected:
                                <div class="status-pill" style="background: rgba(239, 68, 68, 0.1); color: #ef4444;"><i class="fas fa-times-circle"></i> Reddedildi</div>
                                break;
                            case ReservationStatus.Cancelled:
                                <div class="status-pill" style="background: rgba(148, 163, 184, 0.1); color: #94a3b8;"><i class="fas fa-ban"></i> İptal Edildi</div>
                                break;
                        }
                    </div>
                </div>

                <div style="background:rgba(0,0,0,0.2); border:1px solid var(--glass-border); border-radius:12px; padding:20px; margin-bottom:25px;">
                    <div class="row">
                        <div class="col-md-6 mb-3 mb-md-0">
                            <label style="color:var(--muted); font-size:12px; text-transform:uppercase; letter-spacing:1px;">Danışan</label>
                            <div style="color:#fff; font-weight:600; font-size:16px; margin-top:5px;">
                                <i class="fas fa-user text-secondary me-2"></i>@Model.FullName
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label style="color:var(--muted); font-size:12px; text-transform:uppercase; letter-spacing:1px;">İletişim</label>
                            <div style="margin-top:5px; display:flex; flex-direction:column; gap:5px;">
                                <a href="mailto:@Model.Email" style="color:var(--accent-2); text-decoration:none; font-weight:500;">
                                    <i class="fas fa-envelope me-2"></i>@Model.Email
                                </a>
                                @if (!string.IsNullOrEmpty(Model.Phone))
                                {
                                    <a href="tel:@Model.Phone" style="color:#cbd5e1; text-decoration:none; font-weight:500;">
                                        <i class="fas fa-phone me-2"></i>@Model.Phone
                                    </a>
                                }
                                else
                                {
                                    <span style="color:var(--muted); font-size:13px; font-style:italic;">Telefon belirtilmemiş</span>
                                }
                            </div>
                        </div>
                    </div>
                </div>

                @if (!string.IsNullOrEmpty(Model.Note))
                {
                    <div style="margin-bottom: 30px;">
                        <label style="color:var(--accent-1); font-size:13px; font-weight:700; text-transform:uppercase; letter-spacing:1px; margin-bottom:10px; display:block;">
                            Danışan Notu
                        </label>
                        <div style="background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.05); border-radius:12px; padding:25px; color:#e2e8f0; font-size:15px; line-height:1.7; white-space:pre-wrap;">@Model.Note</div>
                    </div>
                }

                <div style="display:flex; justify-content:flex-end; gap:15px; border-top:1px solid var(--glass-border); padding-top:20px;" id="actionButtonsContainer">
                    <button type="button" class="btn-secondary" onclick="updateStatus('@Model.Id', 3)" style="color:#ef4444; border-color:rgba(239, 68, 68, 0.3);">
                        <i class="fas fa-times me-2"></i> Reddet
                    </button>

                    <button type="button" class="btn-primary" onclick="updateStatus('@Model.Id', 2)" style="background:var(--accent-1);">
                        <i class="fas fa-check me-2"></i> Randevuyu Onayla
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="successModal" class="modal-overlay" style="display:none; align-items:center; justify-content:center;">
    <div class="modal-box glass-panel" style="width: 400px; padding: 40px 30px; border-radius: 20px; border: 1px solid rgba(16, 185, 129, 0.3); text-align:center; transform: scale(0.9); opacity: 0; transition: all 0.3s ease;">
        <div id="modalIconContainer" style="width: 80px; height: 80px; background: rgba(16, 185, 129, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px auto; color: #10b981; font-size: 35px; box-shadow: 0 0 20px rgba(16, 185, 129, 0.2);">
            <i class="fa-solid fa-circle-check" id="modalIcon"></i>
        </div>
        <h3 style="color:#fff; margin-bottom:10px; font-weight:700;">İşlem Başarılı!</h3>
        <p style="color:var(--muted); font-size:15px; margin-bottom:0;" id="successModalText">Durum güncellendi.</p>
    </div>
</div>

<style>
    .status-pill {
        padding: 6px 15px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 700;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .status-active {
        background: rgba(16, 185, 129, 0.1);
        color: #10b981;
    }

    .status-draft {
        background: rgba(245, 158, 11, 0.1);
        color: #f59e0b;
    }

    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(5px);
        z-index: 9999;
    }

        .modal-overlay.active {
            display: flex !important;
        }

            .modal-overlay.active .modal-box {
                transform: scale(1) !important;
                opacity: 1 !important;
            }
</style>

@section Scripts {
    <script>
        function updateStatus(id, statusValue) {
            const buttonsContainer = document.getElementById('actionButtonsContainer');
            buttonsContainer.style.opacity = '0.5';
            buttonsContainer.style.pointerEvents = 'none';

            $.ajax({
                url: '/Admin/Reservations/UpdateStatus',
                type: 'POST',
                data: { id: id, status: statusValue },
                success: function (result) {
                    if (result.success) {

                        let badgeHtml = '';
                        let modalColor = '';
                        let modalIconCls = '';

                        if (statusValue == 2) {
                            badgeHtml = '<div class="status-pill status-active"><i class="fas fa-check-circle"></i> Onaylandı</div>';
                            modalColor = '#10b981';
                            modalIconCls = 'fa-solid fa-circle-check';
                        } else if (statusValue == 3) {
                            badgeHtml = '<div class="status-pill" style="background: rgba(239, 68, 68, 0.1); color: #ef4444;"><i class="fas fa-times-circle"></i> Reddedildi</div>';
                            modalColor = '#ef4444';
                            modalIconCls = 'fa-solid fa-circle-xmark';
                        }

                        document.getElementById('statusBadgeContainer').innerHTML = badgeHtml;
                        document.getElementById('successModalText').innerText = result.message;

                        const iconContainer = document.getElementById('modalIconContainer');
                        iconContainer.style.color = modalColor;
                        iconContainer.style.background = `rgba(${statusValue == 2 ? '16, 185, 129' : '239, 68, 68'}, 0.1)`;
                        iconContainer.style.boxShadow = `0 0 20px rgba(${statusValue == 2 ? '16, 185, 129' : '239, 68, 68'}, 0.2)`;
                        document.getElementById('modalIcon').className = modalIconCls;

                        const sModal = document.getElementById('successModal');
                        sModal.style.display = 'flex';
                        setTimeout(() => sModal.classList.add('active'), 10);

                        setTimeout(() => {
                            sModal.classList.remove('active');
                            setTimeout(() => sModal.style.display = 'none', 300);
                            buttonsContainer.style.opacity = '1';
                            buttonsContainer.style.pointerEvents = 'auto';
                        }, 2000);

                    } else {
                        alert(result.message);
                        buttonsContainer.style.opacity = '1';
                        buttonsContainer.style.pointerEvents = 'auto';
                    }
                },
                error: function () {
                    alert('İşlem sırasında sunucu hatası oluştu.');
                    buttonsContainer.style.opacity = '1';
                    buttonsContainer.style.pointerEvents = 'auto';
                }
            });
        }
    </script>
}